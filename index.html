<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Observations">
    <title>Observation Journal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
            color: #fff;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 80px;
        }
        .header {
            position: sticky;
            top: 0;
            background: #000;
            border-bottom: 1px solid #27272a;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        .header h1 { font-size: 18px; font-weight: 500; }
        .btn {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .btn:hover { background: #18181b; }
        .settings-panel {
            background: #09090b;
            border-bottom: 1px solid #27272a;
            padding: 16px;
        }
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .settings-header h2 {
            font-size: 14px;
            color: #a1a1aa;
            font-weight: 500;
        }
        .add-cat-btn {
            font-size: 12px;
            padding: 4px 12px;
            background: #27272a;
            border: none;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
        }
        .cat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .cat-color {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        .cat-name {
            flex: 1;
            font-size: 14px;
        }
        .cat-edit-input {
            flex: 1;
            background: #27272a;
            border: none;
            color: #fff;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
        }
        .cat-btn {
            padding: 6px 12px;
            background: none;
            border: none;
            color: #a1a1aa;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
        }
        .cat-btn:hover { background: #27272a; }
        .cat-btn.save { background: #2563eb; color: #fff; }
        .cat-btn.delete { color: #ef4444; }
        .entries {
            padding: 16px;
        }
        .empty-state {
            text-align: center;
            padding: 48px 16px;
            color: #71717a;
        }
        .empty-state p { margin-bottom: 8px; }
        .empty-state .hint { font-size: 14px; }
        .entry {
            border: 1px solid #27272a;
            border-radius: 8px;
            margin-bottom: 8px;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        .entry:hover { border-color: #3f3f46; }
        .entry-main {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            color: #fff;
            cursor: pointer;
        }
        .entry-bar {
            width: 4px;
            min-height: 40px;
            border-radius: 2px;
            flex-shrink: 0;
            margin-top: 4px;
        }
        .entry-content {
            flex: 1;
            min-width: 0;
        }
        .entry-meta {
            display: flex;
            gap: 8px;
            margin-bottom: 4px;
            align-items: center;
        }
        .entry-tag {
            font-size: 12px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .entry-time {
            font-size: 12px;
            color: #71717a;
        }
        .entry-text {
            font-size: 14px;
            line-height: 1.4;
        }
        .entry-text.collapsed {
            overflow: hidden;
        }
        .entry-chevron {
            flex-shrink: 0;
            margin-top: 4px;
            color: #52525b;
            transition: transform 0.2s;
        }
        .entry-chevron.rotated {
            transform: rotate(90deg);
        }
        .entry-actions {
            border-top: 1px solid #27272a;
            padding: 12px;
            background: #09090b;
        }
        .delete-btn {
            background: none;
            border: none;
            color: #ef4444;
            font-size: 12px;
            cursor: pointer;
        }
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #2563eb;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .add-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #09090b;
            border-top: 1px solid #27272a;
            padding: 16px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.3);
        }
        .add-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .add-header h3 {
            font-size: 16px;
            font-weight: 500;
        }
        .close-btn {
            padding: 4px;
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
        }
        .category-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        .category-selector::-webkit-scrollbar { display: none; }
        .cat-pill {
            padding: 6px 12px;
            border-radius: 16px;
            border: none;
            color: #fff;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.6;
        }
        .cat-pill.selected {
            opacity: 1;
            box-shadow: 0 0 0 2px currentColor;
        }
        .cat-pill:not(.selected):hover { opacity: 0.8; }
        .entry-textarea {
            width: 100%;
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            font-size: 14px;
            resize: none;
            margin-bottom: 12px;
            font-family: inherit;
        }
        .entry-textarea:focus {
            outline: none;
            border-color: #3f3f46;
        }
        .save-btn {
            width: 100%;
            padding: 10px;
            background: #2563eb;
            border: none;
            color: #fff;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }
        .save-btn:disabled {
            background: #27272a;
            color: #52525b;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Observations</h1>
        <button class="btn" onclick="toggleSettings()">⚙️</button>
    </div>

    <div id="settingsPanel" class="settings-panel hidden">
        <div class="settings-header">
            <h2>Categories</h2>
            <button class="add-cat-btn" onclick="addCategory()">Add</button>
        </div>
        <div id="categoryList"></div>
    </div>

    <div class="entries" id="entriesList"></div>

    <button class="fab" id="fabBtn" onclick="showAddPanel()">+</button>

    <div id="addPanel" class="add-panel hidden">
        <div class="add-header">
            <h3>New Observation</h3>
            <button class="close-btn" onclick="hideAddPanel()">✕</button>
        </div>
        <div class="category-selector" id="categorySelector"></div>
        <textarea 
            id="entryText" 
            class="entry-textarea" 
            rows="4" 
            placeholder="What did you notice?"
        ></textarea>
        <button class="save-btn" onclick="saveEntry()" id="saveBtn" disabled>Save</button>
    </div>

    <script>
        let entries = [];
        let categories = [
            { name: 'Insight', color: '#3b82f6' },
            { name: 'Pattern', color: '#8b5cf6' },
            { name: 'Question', color: '#ec4899' },
            { name: 'Signal', color: '#f59e0b' }
        ];
        let selectedCategory = null;
        let expandedEntry = null;
        let editingCategory = null;

        // Load data
        function loadData() {
            const savedEntries = localStorage.getItem('observation-entries');
            const savedCategories = localStorage.getItem('observation-categories');
            
            if (savedEntries) entries = JSON.parse(savedEntries);
            if (savedCategories) categories = JSON.parse(savedCategories);
            
            render();
        }

        // Save data
        function saveData() {
            localStorage.setItem('observation-entries', JSON.stringify(entries));
            localStorage.setItem('observation-categories', JSON.stringify(categories));
        }

        // Toggle settings
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('hidden');
            renderCategories();
        }

        // Render categories in settings
        function renderCategories() {
            const list = document.getElementById('categoryList');
            list.innerHTML = categories.map((cat, idx) => {
                if (editingCategory === idx) {
                    return `
                        <div class="cat-item">
                            <input type="color" class="cat-color" value="${cat.color}" 
                                onchange="updateCategoryColor(${idx}, this.value)">
                            <input type="text" class="cat-edit-input" value="${cat.name}" 
                                id="editCatName${idx}">
                            <button class="cat-btn save" onclick="saveCategoryEdit(${idx})">Save</button>
                        </div>
                    `;
                }
                return `
                    <div class="cat-item">
                        <div class="cat-color" style="background: ${cat.color}"></div>
                        <span class="cat-name">${cat.name}</span>
                        <button class="cat-btn" onclick="editCategory(${idx})">✏️</button>
                        <button class="cat-btn delete" onclick="deleteCategory(${idx})">✕</button>
                    </div>
                `;
            }).join('');
        }

        function updateCategoryColor(idx, color) {
            categories[idx].color = color;
        }

        function editCategory(idx) {
            editingCategory = idx;
            renderCategories();
        }

        function saveCategoryEdit(idx) {
            const newName = document.getElementById(`editCatName${idx}`).value.trim();
            if (!newName) return;
            
            const oldName = categories[idx].name;
            categories[idx].name = newName;
            
            // Update entries with old category name
            entries = entries.map(e => 
                e.category === oldName ? { ...e, category: newName } : e
            );
            
            editingCategory = null;
            saveData();
            renderCategories();
            render();
        }

        function addCategory() {
            const name = prompt('Category name:');
            if (!name) return;
            
            const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#06b6d4', '#f97316', '#6366f1'];
            const color = colors[categories.length % colors.length];
            
            categories.push({ name, color });
            saveData();
            renderCategories();
        }

        function deleteCategory(idx) {
            const cat = categories[idx];
            const count = entries.filter(e => e.category === cat.name).length;
            
            if (count > 0) {
                if (!confirm(`Delete "${cat.name}"? ${count} entries will also be deleted.`)) return;
                entries = entries.filter(e => e.category !== cat.name);
            }
            
            categories.splice(idx, 1);
            saveData();
            renderCategories();
            render();
        }

        // Show/hide add panel
        function showAddPanel() {
            document.getElementById('addPanel').classList.remove('hidden');
            document.getElementById('fabBtn').classList.add('hidden');
            renderCategorySelector();
            document.getElementById('entryText').focus();
        }

        function hideAddPanel() {
            document.getElementById('addPanel').classList.add('hidden');
            document.getElementById('fabBtn').classList.remove('hidden');
            document.getElementById('entryText').value = '';
            selectedCategory = null;
            updateSaveButton();
        }

        // Render category selector
        function renderCategorySelector() {
            const selector = document.getElementById('categorySelector');
            selector.innerHTML = categories.map(cat => `
                <button 
                    class="cat-pill ${selectedCategory === cat.name ? 'selected' : ''}"
                    style="background: ${cat.color}"
                    onclick="selectCategory('${cat.name}')"
                >
                    ${cat.name}
                </button>
            `).join('');
        }

        function selectCategory(name) {
            selectedCategory = name;
            renderCategorySelector();
            updateSaveButton();
        }

        // Update save button state
        function updateSaveButton() {
            const text = document.getElementById('entryText').value.trim();
            document.getElementById('saveBtn').disabled = !text || !selectedCategory;
        }

        document.getElementById('entryText').addEventListener('input', updateSaveButton);

        // Save entry
        function saveEntry() {
            const text = document.getElementById('entryText').value.trim();
            if (!text || !selectedCategory) return;

            const entry = {
                id: Date.now(),
                text,
                category: selectedCategory,
                timestamp: new Date().toISOString()
            };

            entries.unshift(entry);
            saveData();
            hideAddPanel();
            render();
        }

        // Delete entry
        function deleteEntry(id) {
            entries = entries.filter(e => e.id !== id);
            expandedEntry = null;
            saveData();
            render();
        }

        // Toggle entry expansion
        function toggleEntry(id) {
            expandedEntry = expandedEntry === id ? null : id;
            render();
        }

        // Truncate to first 10 words
        function truncateText(text, wordLimit = 10) {
            const words = text.split(/\s+/);
            if (words.length <= wordLimit) return text;
            return words.slice(0, wordLimit).join(' ') + '...';
        }

        // Format date
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (date.toDateString() === today.toDateString()) {
                return `Today ${date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`;
            } else if (date.toDateString() === yesterday.toDateString()) {
                return `Yesterday ${date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`;
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
            }
        }

        // Get category color
        function getCategoryColor(name) {
            return categories.find(c => c.name === name)?.color || '#6b7280';
        }

        // Render entries
        function render() {
            const list = document.getElementById('entriesList');
            
            if (entries.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <p>No observations yet.</p>
                        <p class="hint">Tap + to begin.</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = entries.map(entry => {
                const color = getCategoryColor(entry.category);
                const isExpanded = expandedEntry === entry.id;
                
                return `
                    <div class="entry">
                        <button class="entry-main" onclick="toggleEntry(${entry.id})">
                            <div class="entry-bar" style="background: ${color}"></div>
                            <div class="entry-content">
                                <div class="entry-meta">
                                    <span class="entry-tag" style="background: ${color}20; color: ${color}">
                                        ${entry.category}
                                    </span>
                                    <span class="entry-time">${formatDate(entry.timestamp)}</span>
                                </div>
                                <p class="entry-text ${isExpanded ? '' : 'collapsed'}">
                                    ${isExpanded ? entry.text : truncateText(entry.text, 10)}
                                </p>
                            </div>
                            <div class="entry-chevron ${isExpanded ? 'rotated' : ''}">›</div>
                        </button>
                        ${isExpanded ? `
                            <div class="entry-actions">
                                <button class="delete-btn" onclick="event.stopPropagation(); deleteEntry(${entry.id})">
                                    Delete
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Initialize
        loadData();
    </script>
</body>
</html>
